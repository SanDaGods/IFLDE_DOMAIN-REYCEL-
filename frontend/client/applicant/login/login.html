<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login & Register</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="images/logo.png" />
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <link rel="stylesheet" href="font-awesome.css" />
</head>
<body>
  <div class="wrapper active-popup">
    <!-- Forms and content here: login, register, forgot password -->
    <!-- Replace with your full form HTML layout -->

    <!-- Example login form -->
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button type="submit">Login</button>
    </form>

    <!-- Example register form -->
    <form id="registerForm">
      <input type="email" id="regEmail" placeholder="Email" />
      <input type="password" id="regPassword" placeholder="Password" />
      <input type="password" id="confirmPassword" placeholder="Confirm Password" />
      <button type="submit">Register</button>
    </form>
  </div>

  <div id="terms-con" style="display:none;">
    <p>Terms and Conditions...</p>
    <button id="accept-btn">Accept</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const wrapper = document.querySelector(".wrapper");

      if (wrapper) {
        wrapper.classList.add("active-popup");
      }

      const buttons = {
        close: document.querySelector(".icon-close"),
        registerLink: document.querySelector(".register-link"),
        loginLink: document.querySelector(".login-link"),
        forgotLink: document.querySelector(".forgot-link"),
      };

      if (document.referrer) {
        sessionStorage.setItem("previousPage", document.referrer);
      }

      const resetInputs = () => {
        wrapper?.querySelectorAll("input").forEach((input) => {
          if (input.type === "checkbox") {
            input.checked = false;
          } else {
            input.value = "";
          }
        });
      };

      const showForm = (formType = "") => {
        wrapper?.classList.remove(
          "active",
          "active-forgot",
          "active-verification",
          "active-new-password"
        );
        if (formType) wrapper?.classList.add(formType);
        resetInputs();
      };

      buttons.registerLink?.addEventListener("click", (e) => {
        e.preventDefault();
        showForm("active");
      });

      buttons.loginLink?.addEventListener("click", (e) => {
        e.preventDefault();
        showForm("");
      });

      buttons.forgotLink?.addEventListener("click", (e) => {
        e.preventDefault();
        showForm("active-forgot");
      });

      const resetForm = document.getElementById("resetForm");
      const verificationForm = document.getElementById("verificationForm");
      const newPasswordForm = document.getElementById("newPasswordForm");

      resetForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        document.querySelector(".form-box.forgot").style.display = "none";
        verificationForm.style.display = "block";
        wrapper.classList.add("active-verification");
      });

      const verifyCodeForm = document.getElementById("verifyCodeForm");
      verifyCodeForm?.addEventListener("submit", (e) => {
        e.preventDefault();
        verificationForm.style.display = "none";
        newPasswordForm.style.display = "block";
        wrapper.classList.add("active-new-password");
      });

      const newPasswordSubmit = document.getElementById("newPasswordSubmit");
      newPasswordSubmit?.addEventListener("submit", (e) => {
        e.preventDefault();

        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (newPassword !== confirmPassword) {
          showNotification("Passwords do not match. Please try again.");
          return;
        }

        showNotification("Password successfully reset! Redirecting to login page...");
        showForm("");
      });

      document.querySelectorAll(".toggle-password").forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const input = toggle.parentElement.querySelector("input");
          const icon = toggle.querySelector("ion-icon");

          if (input.type === "password") {
            input.type = "text";
            icon.setAttribute("name", "eye");
          } else {
            input.type = "password";
            icon.setAttribute("name", "eye-off");
          }
        });
      });

      document.getElementById("terms-link")?.addEventListener("click", function (event) {
        event.preventDefault();
        document.getElementById("terms-con").style.display = "block";
      });

      document.getElementById("accept-btn")?.addEventListener("click", function () {
        document.getElementById("terms-con").style.display = "none";
        document.getElementById("terms-checkbox").checked = true;
      });

      buttons.close?.addEventListener("click", () => {
        resetInputs();
        wrapper?.classList.remove(
          "active-popup",
          "active",
          "active-forgot",
          "active-verification",
          "active-new-password"
        );
        window.location.href = "/index.html";
      });
    });

    const BACKEND_URL = "https://eteeapbackend-production.up.railway.app";

    // Registration
    document.getElementById("registerForm")?.addEventListener("submit", async (event) => {
      event.preventDefault();

      const email = document.getElementById("regEmail").value.trim().toLowerCase();
      const password = document.getElementById("regPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      if (!email || !password || !confirmPassword) {
        showNotification("Please fill in all fields");
        return;
      }

      if (!email.includes("@") || !email.includes(".")) {
        showNotification("Please enter a valid email address (e.g., user@example.com)");
        return;
      }

      if (password !== confirmPassword) {
        showNotification("Passwords do not match!");
        return;
      }

      if (password.length < 8) {
        showNotification("Password must be at least 8 characters");
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Registering...";

      try {
        const response = await fetch(`${BACKEND_URL}/api/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        const contentType = response.headers.get("content-type");

        if (!response.ok) {
          const errorText = await response.text();
          if (contentType && contentType.includes("application/json")) {
            const data = JSON.parse(errorText);
            throw new Error(data.error || "Registration failed");
          } else {
            throw new Error(`Registration failed: ${errorText}`);
          }
        }

        const data = await response.json();
        showNotification("Registration successful! Please fill out your personal information.");
        localStorage.setItem("userId", data.data.userId);
        localStorage.setItem("applicantId", data.data.applicantId);
        window.location.href = "https://eteeap-domain-uluo.vercel.app/frontend/client/applicant/info/information.html";
      } catch (error) {
        console.error("Registration error:", error);
        showNotification(`Registration failed: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    // Login
    document.getElementById("loginForm")?.addEventListener("submit", async (event) => {
      event.preventDefault();

      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) {
        showNotification("Please enter both email and password.");
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Logging in...";

      try {
        const response = await fetch(`${BACKEND_URL}/api/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
          credentials: "include",
        });

        const contentType = response.headers.get("content-type");

        if (!response.ok) {
          const errorText = await response.text();
          if (contentType && contentType.includes("application/json")) {
            const data = JSON.parse(errorText);
            throw new Error(data.error || "Login failed");
          } else {
            throw new Error("Login failed: Unexpected server response.");
          }
        }

        if (contentType && contentType.includes("application/json")) {
          const data = await response.json();
          showNotification("Login successful!");
          localStorage.setItem("userId", data.data.userId);
          localStorage.setItem("userEmail", data.data.email);
          window.location.href = "../Timeline/timeline.html";
        } else {
          throw new Error("Unexpected server response. Please try again later.");
        }
      } catch (error) {
        console.error("Login error:", error);
        showNotification(`Login failed: ${error.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });

    function showNotification(message, type = "info") {
      const existingNotifications = document.querySelectorAll(".notification");
      existingNotifications.forEach((n) => n.remove());

      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    }
  </script>
</body>
</html>
